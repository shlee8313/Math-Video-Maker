# 🎤 OpenAI TTS + Whisper 완벽 가이드

## 📋 목차
1. [설정 방법](#설정-방법)
2. [주요 개선 사항](#주요-개선-사항)
3. [Whisper 프롬프트 최적화](#whisper-프롬프트-최적화)
4. [묵음 구간 처리](#묵음-구간-처리)
5. [이상한 단어 필터링](#이상한-단어-필터링)
6. [실행 예시](#실행-예시)
7. [문제 해결](#문제-해결)

---

## 🔧 설정 방법

### 1. OpenAI API 키 발급

1. https://platform.openai.com/ 접속
2. "API Keys" 메뉴
3. "Create new secret key" 클릭
4. 생성된 키 복사 (sk-proj-...)

### 2. .env 파일 생성

프로젝트 루트에 `.env` 파일 생성:

```env
OPENAI_API_KEY=sk-proj-your-actual-key-here
```

### 3. 패키지 설치

```powershell
pip install openai python-dotenv
```

---

## ✨ 주요 개선 사항

### Before (문제점)
```
❌ TTS 생성 후 검증 없음
❌ 묵음 구간 무시
❌ 이상한 단어 그대로 사용
❌ 인사말, 감사 등 추가됨
❌ 타임스탬프 부정확
```

### After (개선됨)
```
✅ OpenAI TTS → Whisper로 검증
✅ 묵음 구간 자동 감지
✅ 이상한 단어 자동 필터링
✅ 인사말/감사 철저히 차단
✅ 타임스탬프 정확도 검증
```

---

## 🎯 Whisper 프롬프트 최적화

### 엄격한 규칙 프롬프트

```python
prompt = """[엄격 규칙]
1. 음성에 들린 내용만 정확히 전사
2. 인사말, 감사, 추임새, 감탄사 절대 추가 금지
3. 묵음 구간은 그대로 묵음으로 유지 (시간 엄수)
4. 타임스탬프는 실제 발화 시간 정확히 반영
5. 음성 외 배경음, 잡음 무시

이것은 수학 교육 영상 나레이션입니다.
수학 용어: 미분, 적분, 벡터, 내적, 제곱근 등

예상 내용: {원본 텍스트 일부}"""
```

### 왜 중요한가?

**Whisper는 프롬프트를 "힌트"로 사용합니다:**
- 인사말 금지 명시 → 실제로 추가 안 함
- 수학 용어 제시 → 인식 정확도 향상
- 원본 텍스트 일부 제공 → 맥락 이해

---

## 🔇 묵음 구간 처리

### 자동 감지

```python
silence_gaps = [
    {
        "start": 5.2,
        "end": 7.5,
        "duration": 2.3,  # ← 2.3초 묵음!
        "after_word": "미분은",
        "before_word": "순간"
    }
]
```

### 중요성

**묵음 = 애니메이션 wait() 시간!**

```python
# 묵음이 2.3초면
self.wait(2.3)  # 정확히 이만큼 대기해야 싱크 맞음
```

### 긴 묵음 경고

```
⚠️ 2초 이상 긴 묵음: 1개
   - 2.30초 ('미분은' → '순간')
```

이런 경고가 뜨면:
- 의도된 휴지기인지 확인
- TTS 텍스트에 문제가 없는지 체크

---

## 🚫 이상한 단어 필터링

### 필터링 대상

```python
FORBIDDEN_WORDS = {
    # 인사말
    "안녕하세요", "감사합니다", "여러분안녕하세요",
    
    # 추임새
    "어", "음", "그", "아", "에",
    
    # 마무리 멘트
    "끝", "마칩니다", "이상입니다",
    
    # 기타
    "자막", "구독", "좋아요", "알림"
}
```

### 필터링 로직

1. **금지 단어 체크**
   ```
   🚫 필터링: '안녕하세요' (금지 단어)
   ```

2. **너무 짧은 발화**
   ```
   🚫 필터링: '어' (너무 짧음: 0.03초)
   ```

3. **원본에 없는 단어**
   ```
   🚫 필터링: '구독' (원본에 없음)
   ```

### 수학 용어 변형 허용

```python
# "미분" → "미분을", "미분의", "미분은" 모두 허용
MATH_TERMS_VARIANTS = {
    "미분": ["미분을", "미분의", "미분은"],
    "적분": ["적분을", "적분의", "적분은"],
    "벡터": ["벡터를", "벡터의", "벡터는", "벡터가"],
}
```

---

## 📊 실행 예시

### 콘솔 출력 (실제)

```
============================================================
🎬 씬 s1 처리 중...
============================================================

🎤 [s1] OpenAI TTS 음성 생성 중...
   텍스트: 여러분, 두 벡터가 얼마나 같은 방향을 보고 있는지...
   ✅ OpenAI API 연결 완료
   🔊 TTS 생성 중... (10~20초 소요)
   ✅ TTS 생성 완료: s1_audio.mp3
   
   📊 Whisper 타임스탬프 추출 중... (5~10초 소요)
   🚫 필터링: '안녕하세요' (금지 단어)
   🚫 필터링: '어' (너무 짧음: 0.03초)
   ✅ 2개 이상한 단어 제거됨
   
   ✅ 타임스탬프 추출 완료
   ⏱️  실제 음성 길이: 10.85초
   📝 추출된 텍스트: 여러분 두 벡터가 얼마나 같은 방향을...
   📊 단어 타임스탬프: 42개
   🔇 묵음 구간: 3개
   ⚠️ 2초 이상 긴 묵음: 1개
      - 2.10초 ('벡터가' → '내적입니다')
   ✅ 전사 정확도 우수 (94.2%)

⏱️  [s1] 타이밍 검증:
   설계: 12.00초
   실제: 10.85초
   차이: +1.15초
   🔇 총 묵음 시간: 4.50초 (3개 구간)
   ⚠️ 음성이 1.15초 짧음
   ➕ wait(1.15) 추가 예정
```

---

## 🎬 생성된 타이밍 JSON

```json
{
  "audio_file": "output/P20251226051305/0_audio/s1_audio.mp3",
  "actual_duration": 10.85,
  "full_text": "여러분 두 벡터가 얼마나 같은 방향을 보고 있는지 숫자 하나로 표현할 수 있다면 믿으시겠어요",
  "words": [
    {
      "text": "여러분",
      "start": 0.0,
      "end": 0.48,
      "duration": 0.48
    },
    {
      "text": "두",
      "start": 0.52,
      "end": 0.68,
      "duration": 0.16
    },
    {
      "text": "벡터가",
      "start": 0.72,
      "end": 1.15,
      "duration": 0.43
    }
  ],
  "silence_gaps": [
    {
      "start": 3.45,
      "end": 5.55,
      "duration": 2.10,
      "after_word": "벡터가",
      "before_word": "내적입니다"
    }
  ]
}
```

---

## 🔧 문제 해결

### 1. "OPENAI_API_KEY not found"

```
⚠️ OPENAI_API_KEY가 .env 파일에 없습니다.
ℹ️ 더미 데이터로 진행합니다.
```

**해결:**
1. `.env` 파일 생성 확인
2. API 키 정확히 입력
3. `python-dotenv` 설치 확인

---

### 2. TTS 생성이 너무 느림

```
🔊 TTS 생성 중... (10~20초 소요)
[30초 경과...]
```

**원인:**
- OpenAI 서버 부하
- 긴 텍스트 (500자 이상)

**해결:**
- 씬을 더 짧게 분할 (각 씬 150~300자)
- `tts-1` 모델 사용 (빠르지만 품질 낮음)

```python
model="tts-1",  # tts-1-hd 대신
```

---

### 3. Whisper 인식 정확도 낮음

```
⚠️ 전사 정확도 낮음 (65.3%)
원본: 여러분, 미분이 무엇인지...
전사: 여러분 미분이 뭔지...
```

**원인:**
- TTS 음성 품질 문제
- 프롬프트 부족

**해결:**
1. TTS 속도 조정:
   ```python
   speed=0.95,  # 조금 느리게
   ```

2. 프롬프트 강화:
   ```python
   prompt=f"""원문 그대로: {원본_텍스트_전체}"""
   ```

---

### 4. 이상한 단어가 계속 나옴

```
🚫 필터링: '구독' (원본에 없음)
🚫 필터링: '좋아요' (원본에 없음)
```

**이미 필터링 중이므로 문제 없음!**

만약 더 추가하려면:
```python
FORBIDDEN_WORDS = {
    # 기존...
    "채널", "영상", "시청",  # ← 추가
}
```

---

### 5. 묵음이 너무 많음

```
🔇 묵음 구간: 15개
⚠️ 2초 이상 긴 묵음: 5개
```

**원인:**
- TTS 텍스트에 문장이 너무 많이 나뉨
- 속도가 너무 느림

**해결:**
1. 문장 통합:
   ```
   Before: "미분은 변화율입니다. 속도를 나타냅니다."
   After: "미분은 변화율로 속도를 나타냅니다."
   ```

2. 속도 증가:
   ```python
   speed=1.1,  # 10% 빠르게
   ```

---

## 📈 성능 지표

### TTS 생성 시간
- **짧은 텍스트 (100자)**: 5~8초
- **보통 텍스트 (300자)**: 10~15초
- **긴 텍스트 (500자)**: 15~25초

### Whisper 처리 시간
- **10초 음성**: 3~5초
- **30초 음성**: 8~12초
- **60초 음성**: 15~20초

### 총 소요 시간 (씬 1개)
```
TTS 생성: 12초
Whisper: 5초
필터링: 1초
검증: 1초
----------
총: 약 20초
```

---

## 🎯 베스트 프랙티스

### 1. 텍스트 준비

```python
# ✅ 좋은 예
"여러분, 벡터의 내적은 두 벡터의 방향 일치도를 나타냅니다."

# ❌ 나쁜 예
"여러분 안녕하세요! 오늘은... 음... 벡터의, 그 내적에 대해 말씀드리겠습니다!"
```

### 2. 씬 길이

```python
# ✅ 적절: 150~300자, 10~20초
scene_text = "..."  # 250자

# ❌ 너무 김: 500자+, 40초+
scene_text = "..."  # 600자
```

### 3. 묵음 활용

```python
# 의도적인 긴 묵음을 원한다면 TTS 텍스트에 표시
text = "미분은 변화율입니다... 이제 예시를 봅시다."
#                          ^^^ 이 부분이 2초 묵음으로 인식됨
```

---

## ✅ 체크리스트

파이프라인 실행 전:
- [ ] `.env` 파일에 OPENAI_API_KEY 설정
- [ ] `openai`, `python-dotenv` 패키지 설치
- [ ] 대본 텍스트 정리 (인사말 제거)
- [ ] 씬당 150~300자 유지
- [ ] 인터넷 연결 확인 (API 호출 필요)

실행 후 확인:
- [ ] `0_audio/` 폴더에 mp3 파일 생성
- [ ] 타임스탬프 JSON 파일 생성
- [ ] 전사 정확도 90% 이상
- [ ] 이상한 단어 필터링 확인
- [ ] 묵음 구간 합리적인지 확인

---

## 🚀 다음 단계

1. **TTS 음성 확인**
   ```powershell
   # 생성된 음성 파일 재생
   start output/P20251226XXXXXX/0_audio/s1_audio.mp3
   ```

2. **타이밍 검증**
   - 실제 vs 설계 시간 확인
   - 묵음 구간 확인

3. **Manim 렌더링**
   - 타이밍 맞춰진 코드로 렌더링
   - 음성 + 영상 합성

---

## 💡 팁

### 한국어 발음 최적화

```python
# 숫자는 한글로
"3×4 = 12" → "삼 곱하기 사는 십이"

# 영문은 한글 발음으로
"AI" → "에이아이"
"API" → "에이피아이"
```

### 목소리 선택

```python
# 중성적: alloy (권장)
# 여성: nova
# 남성: onyx
# 활기찬: fable
# 차분한: echo

voice="alloy"  # 수학 교육에 가장 적합
```

### 비용 관리

```
OpenAI TTS: $15 per 1M characters
Whisper: $0.006 per minute

예시 (180초 영상, 5개 씬):
- TTS: 1500 characters × 5 = 7500 chars = $0.11
- Whisper: 3 min × 5 = 15 min = $0.09
총: 약 $0.20 per 영상
```

---

**이제 완벽한 TTS + Whisper 시스템이 준비되었습니다!** 🎉
